<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&amp;display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="/assets/styles/components/sidebar.css">
    <link rel="stylesheet" href="/assets/styles/room.css">
</head>
<body>
    <div class="sidebar" id="sidebar-placeholder"></div>

    <div class="meeting-screen">
        <div class="meeting-header">
            <h3 class="meeting-title">Let's get it
                <span>-</span>
            </h3>
            <div class="member-count">
                <i class="fas fa-users"></i>
                <span>3</span>
            </div>
            <div class="dropdown-container">
                <button class="dropdown-button">
                    <i class="fas fa-chevron-down"></i>
                </button>
                <button class="dropup-button">
                    <i class="fas fa-chevron-up"></i>
                </button>
                <div class="dropdown-menu" style="display: none;">
                    <ul>
                        <li>
                            <img src="/assets/images/avatar/avtgin.jpg" alt="Avatar 1" class="member-avatar">
                            <span>Gin</span>
                            <i id="host" class="fas fa-crown"></i>
                        </li>
                        <li>
                            <img src="/assets/images/avatar/avtchianti.jpg" alt="Avatar 2" class="member-avatar">
                            <span>Chianti</span>
                        </li>
                        <li>
                            <img src="/assets/images/avatar/avtlight.jpg" alt="Avatar 3" class="member-avatar">
                            <span>Light</span>
                        </li>
                        <li>
                            <img src="/assets/images/avatar/avtsherry.jpg" alt="Avatar 4" class="member-avatar">
                            <span>Sherry</span>
                        </li>
                        <li>
                            <img src="/assets/images/avatar/avtvermouth.jpg" alt="Avatar 5" class="member-avatar">
                            <span>Vermouth</span>
                        </li>
                        <li>
                            <img src="/assets/images/avatar/avtvodka.jpg" alt="Avatar 6" class="member-avatar">
                            <span>Vodka</span>
                        </li>
                        <li>
                            <img src="/assets/images/avatar/avtbourbon.jpg" alt="Avatar 7" class="member-avatar">
                            <span>Bourbon</span>
                        </li>
                        <li>
                            <img src="/assets/images/avatar/avtkir.jpg" alt="Avatar 8" class="member-avatar">
                            <span>Kir</span>
                        </li>
                        <li>
                            <img src="/assets/images/avatar/avtkorn.jpg" alt="Avatar 9" class="member-avatar">
                            <span>Korn</span>
                        </li>
                        <!-- Thêm các thành viên khác -->
                    </ul>
                </div>
                
            </div>
            
        </div>

        <!-- Video Container -->
        <div id="video-container">
            <video id="local-video" autoplay muted></video>
            <video id="remote-video" autoplay></video>
        </div>
    
        <img class="background-image" 
             src="/assets/images/background/cover1.jpg" 
             alt="Meeting Background" />
    
        <div class="meeting-controls">
            <!-- Microphone button -->
            <button id="toggle-mic" class="control-button control-button-microphone">
                <i class="fas fa-microphone-slash"></i> <!-- Trạng thái tắt -->
                <i class="fas fa-microphone active-icon"></i> <!-- Trạng thái bật -->
            </button>
            
            <!-- Chat button -->
            <button class="control-button control-button-chat">
                <i class="fas fa-comment-dots"></i>
            </button>
            
            <!-- Share screen button -->
            <button id="share-screen" class="control-button control-button-share">
                    <i class="fas fa-share-square"></i>
            </button>
            
            <!-- Hangup button -->
            <button class="control-button control-button-hangup">
                <i class="fas fa-phone fa-rotate-by" style="--fa-rotate-angle: 225deg;"></i>
            </button>
        </div>
        <!-- Phần chat -->
        <div class="meeting-chat">
            <!-- Thanh điều khiển -->
            <div class="chat-control">
                <button class="chat-detail-btn">
                    <i class="fas fa-info-circle"></i>
                </button>
                <button class="chat-close-btn">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div id="chat-box" class="chat-messages-container">
                <!-- Tin nhắn ví dụ -->

            </div>
            
            
            <!-- Hộp chat -->
            <div class="chat-input-area">
                <input id="chat-input" type="text" class="chat-input" placeholder="Nhập tin nhắn của bạn..." />
                <button class="chat-file-btn">
                    <i class="fas fa-file-upload"></i>
                </button>
                <button id="send-message" class="chat-send-btn">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>

            <!-- Chi tiết chat -->
            <div class="chat-details-container">
                <!-- Nút Back -->
                <div class="details-back">
                    <button class="details-back-btn">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                </div>
                
                <!-- Điều khiển Media/Files -->
                <div class="details-control">
                    <button class="details-media-btn active">Media</button>
                    <button class="details-files-btn">Files</button>
                </div>

                <div class="details-content">
                    <!-- Media -->
                    <div class="media-content">
                        <img src="/assets/images/avatar/avtsherry.jpg" alt="Media Image">
                        <img src="/assets/images/avatar/avtchianti.jpg" alt="Media Image">
                    </div>
                    <!-- Files -->
                    <div class="files-content" style="display: none;">
                        <a href="/files/example.pdf" download>example.pdf</a>
                        <a href="/files/mafia.txt" download>mafia.txt</a>
                    </div>
                </div>
            </div>
            
        </div>

    </div>

    <script>
        // Lấy các phần tử trong DOM
        const localVideo = document.getElementById("local-video");
        const remoteVideo = document.getElementById("remote-video");
        const chatBox = document.getElementById("chat-box");
        const chatInput = document.getElementById("chat-input");
        const sendMessageButton = document.getElementById("send-message");
        const toggleMicButton = document.getElementById("toggle-mic");
        const shareScreenButton = document.getElementById("share-screen");

        let localStream;
        let remoteStream;
        let peerConnection;
        let isMicMuted = false;
        let isScreenSharing = false;

        const roomId = 1;
        const username = localStorage.getItem("username");
        console.log(username);

        const socket = new WebSocket(`ws://127.0.0.1:8000/ws/room/${roomId}/`);
    
    
        socket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            
            // Xử lý offer
            if (data.type === 'offer') {
                handleOffer(data.offer);
            }
            
            // Xử lý answer
            if (data.type === 'answer') {
                handleAnswer(data.answer);
            }
            
            // Xử lý ICE candidate
            if (data.type === 'candidate') {
                handleCandidate(data.candidate);
            }
            
            // Xử lý message chat
            if (data.type === 'message') {
                displayMessage(data.message, data.user);
            }

            if (data.type === 'initial_messages') {
                displayInitialMessages(data.messages);
            }
        };

        // Tạo peer connection
        function createPeerConnection() {
            const configuration = {
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' }  // STUN server của Google
                ]
            };
            peerConnection = new RTCPeerConnection(configuration);

            // Lắng nghe sự kiện ICE candidate
            peerConnection.onicecandidate = function(event) {
                if (event.candidate) {
                    socket.send(JSON.stringify({
                        type: 'candidate',
                        candidate: event.candidate
                    }));
                }
            };

            // Lắng nghe khi có video từ remote peer
            peerConnection.ontrack = function(event) {
                remoteVideo.srcObject = event.streams[0];
                remoteStream = event.streams[0];
            };

            // Thêm stream (audio/video) từ local vào peer connection
            localStream.getTracks().forEach(track => {
                peerConnection.addTrack(track, localStream);
            });
        }

        // Xử lý offer
        async function handleOffer(offer) {
            await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
            const answer = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(answer);

            // Gửi answer về server
            socket.send(JSON.stringify({
                type: 'answer',
                answer: peerConnection.localDescription
            }));
        }

        // Xử lý answer
        function handleAnswer(answer) {
            peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
        }

        // Xử lý ICE candidate
        function handleCandidate(candidate) {
            peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
        }

        // Chạy getUserMedia để lấy quyền truy cập vào microphone và camera
        async function getUserMedia() {
            try {
                const constraints = {
                    audio: true
                };

                // Lấy quyền truy cập vào microphone và camera
                localStream = await navigator.mediaDevices.getUserMedia(constraints);

                // Gán stream cho video local
                localVideo.srcObject = localStream;

                // Tạo peer connection khi đã có local stream
                createPeerConnection();
            } catch (err) {
                console.error("Error getting media: ", err);
            }
        }

        // Khởi tạo cuộc gọi
        async function startCall() {
            await getUserMedia();
            const offer = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offer);

            // Gửi offer qua WebSocket
            socket.send(JSON.stringify({
                type: 'offer',
                offer: peerConnection.localDescription
            }));
        }

        // Chuyển đổi trạng thái micro (mute/unmute)
        toggleMicButton.addEventListener('click', function() {
            const audioTrack = localStream.getAudioTracks()[0];
            if (isMicMuted) {
                audioTrack.enabled = true;
            } else {
                audioTrack.enabled = false;
            }
            isMicMuted = !isMicMuted;
        });

        // Chia sẻ màn hình
        shareScreenButton.addEventListener('click', async function() {
            try {
                const screenStream = await navigator.mediaDevices.getDisplayMedia({ video: true });
                // Thay thế stream video hiện tại bằng stream chia sẻ màn hình
                localStream.getTracks().forEach(track => track.stop());  // Dừng tất cả các track hiện tại
                localStream = screenStream;
                localVideo.srcObject = screenStream;

                // Cập nhật trạng thái chia sẻ màn hình
                isScreenSharing = true;

                // Cập nhật stream mới vào peer connection
                peerConnection.getSenders().forEach(sender => sender.replaceTrack(screenStream.getTracks()[0]));

            } catch (err) {
                console.error("Error sharing screen: ", err);
            }
        });


        // Gửi tin nhắn chat
        sendMessageButton.addEventListener('click', function() {
            const message = chatInput.value;
            if (message.trim() !== '') {
                socket.send(JSON.stringify({
                    type: 'message',
                    content: message,
                    user: username
                }));
                chatInput.value = '';
            }
        });

        // Hiển thị các tin nhắn ban đầu (trước khi người dùng gửi tin nhắn)
        function displayInitialMessages(messages) {
            messages.forEach(function(msg) {
                const messageElement = document.createElement('div');
                // Kiểm tra nếu tin nhắn là của chủ sở hữu
                if (msg.user === username) {
                    messageElement.classList.add('chat-message-owner'); // Gán class cho tin nhắn của owner
                    messageElement.innerHTML = `
                        <div class="chat-content-owner">
                            <span class="chat-name-owner">${msg.user}</span>
                            <p class="chat-text-owner">${msg.message}</p>
                        </div>
                        <img src="/assets/images/avatar/avtgin.jpg" alt="Avatar" class="chat-avatar-owner">
                    `;
                } else {
                    messageElement.classList.add('chat-message');
                    messageElement.innerHTML = `
                        <img src="/assets/images/avatar/avtgin.jpg" alt="Avatar" class="chat-avatar">
                        <div class="chat-content">
                            <span class="chat-name">${msg.user}</span>
                            <p class="chat-text">${msg.message}</p>
                        </div>
                    `;
                }
                chatBox.appendChild(messageElement);
            });
        }

        function displayMessage(message, user) {
            const messageElement = document.createElement('div');
            if (user === username) {
                messageElement.classList.add('chat-message-owner'); // Gán class cho tin nhắn của owner
                messageElement.innerHTML = `
                    <div class="chat-content-owner">
                        <span class="chat-name-owner">${user}</span>
                        <p class="chat-text-owner">${message}</p>
                    </div>
                    <img src="/assets/images/avatar/avtgin.jpg" alt="Avatar" class="chat-avatar-owner">
                `;
            } else {
                messageElement.classList.add('chat-message');
                messageElement.innerHTML = `
                    <img src="/assets/images/avatar/avtgin.jpg" alt="Avatar" class="chat-avatar">
                    <div class="chat-content">
                        <span class="chat-name">${user}</span>
                        <p class="chat-text">${message}</p>
                    </div>
                `;
            }
            chatBox.appendChild(messageElement);
        }


        // Bắt đầu cuộc gọi khi trang web tải
        window.onload = function() {
            startCall();
        };
    </script>
    

    <script src="/js/components/sidebar.js"></script>
    <script type="module" src="/js/pages/room.js"></script>
</body>
</html>