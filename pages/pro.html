<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            line-height: 1.6;
        }
        img.profile-avatar {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 50%;
        }
        .form-control {
            margin: 10px 0;
            padding: 8px;
            width: 100%;
            max-width: 300px;
        }
        .btn {
            margin-top: 10px;
            padding: 8px 12px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <h1>User Profile</h1>
    <div id="profile-container">
        <img id="profile-avatar" src="" alt="Profile Avatar" class="profile-avatar">
        <p><strong>Username:</strong> <span id="profile-username"></span></p>
        <p><strong>Email:</strong> <span id="profile-email"></span></p>
        <p><strong>Joined Date:</strong> <span id="profile-join-date"></span></p>
    </div>

    <h2>Update Profile</h2>
    <form id="update-profile-form">
        <label for="new-avatar">Change Avatar:</label>
        <input type="file" id="new-avatar" class="form-control" accept="image/*">
        
        <label for="new-username">Username:</label>
        <input type="text" id="new-username" class="form-control" disabled>
        
        <label for="new-email">Email:</label>
        <input type="email" id="new-email" class="form-control">
        
        <button type="button" class="btn btn-primary" onclick="updateProfile()">Save Changes</button>
    </form>

    <button onclick="logout()" class="btn btn-secondary">Logout</button>

    <script>
        // Function to fetch and display profile data
        async function loadProfile() {
            const token = localStorage.getItem("token"); // Retrieve token from localStorage

            if (!token) {
                alert("You need to login first!");
                window.location.href = "login.html"; // Redirect back to login page if not logged in
                return;
            }

            try {
                const response = await fetch("http://127.0.0.1:8000/api/accounts/users/profile/", {
                    method: "GET",
                    headers: {
                        "Authorization": `Token ${token}`,
                        "Content-Type": "application/json"
                    }
                });
                const data = await response.json();
                console.log(data);

                // Populate profile data
                if (data.avatar && data.avatar.includes('/media/')) {
                    data.avatar = data.avatar.replace('/media/', '/api/accounts/media/');
                }
                document.getElementById("profile-avatar").src = data.avatar || "/assets/images/default-profile.jpg";
                document.getElementById("profile-username").innerText = data.username;
                document.getElementById("profile-email").innerText = data.email;
                document.getElementById("profile-join-date").innerText = data.join_date || "N/A";

                // Pre-fill form fields
                document.getElementById("new-username").value = data.username;
                document.getElementById("new-email").value = data.email;
            } catch (error) {
                console.error("Error loading profile:", error);
            }
        }

        // Function to update profile
        async function updateProfile() {
            const token = localStorage.getItem("token");
            if (!token) {
                alert("You need to login first!");
                return;
            }

            const username = document.getElementById("new-username").value;
            const email = document.getElementById("new-email").value;
            const avatar = document.getElementById("new-avatar").files[0];

            const formData = new FormData();
            formData.append("username", username);
            formData.append("email", email);
            if (avatar) {
                formData.append("profile_picture", avatar);
            }

            try {
                const response = await fetch("http://127.0.0.1:8000/api/accounts/users/profile/update/", {
                    method: "PUT", // hoặc PATCH tùy vào cấu hình API
                    headers: {
                        "Authorization": `Token ${token}`,
                    },
                    body: formData
                });

                if (response.ok) {
                    const data = await response.json();
                    alert("Profile updated successfully!");
                    loadProfile(); // Reload profile
                } else {
                    const data = await response.json();
                    console.error("Error response data:", data); // Log chi tiết lỗi trả về
                    alert("Failed to update profile. " + (data.detail || "Unknown error"));
                }
            } catch (error) {
                console.error("Error updating profile:", error);
                alert("An error occurred while updating the profile.");
            }
        }

        function logout() {
            localStorage.removeItem("token"); // Remove token
            window.location.href = "login.html"; // Redirect to login page
        }

        // Load profile on page load
        window.onload = loadProfile;
    </script>
</body>
</html>
